<!--
 * PackageReadme.targets
 * 
 *   Created: 2022-10-21-11:40:42
 *   Modified: 2022-11-12-03:55:06
 * 
 *   Author: Justin Chase <justin@justinwritescode.com>
 *   
 *   Copyright Â© 2022-2023 Justin Chase, All Rights Reserved
 *      License: MIT (https://opensource.org/licenses/MIT)
-->

<Project>
	<Target Name="CheckReadmeExists" BeforeTargets="EnsurePackageReadme">
			<Warning Condition="!Exists('$(PackageReadmeFileHintPath)')"
				Code="README.MD_NOT_FOUND"
				File="$(MSBuildProjectDirectory)/README.md" 
				Text="No readme file exists for the package '$(MSBuildProjectName)'; using the generated backup README.md file." />
	</Target>

  <Target Name="EnsurePackageReadme" BeforeTargets="GetPackageContents" DependsOnTargets="GitInfo;GetPackageMetadata;CheckReadmeExists;SetPackageDescription">
    <!-- Fallback to using the package's description as the README.md contents -->
    <ItemGroup Condition="!Exists('$(PackageReadmeFileHintPath)')">
      <ReadmeFileContents Include="# $(PackageId)" />
      <ReadmeFileContents Include="$(Description)" />
    </ItemGroup>

    <!-- Read the contents from the package README file -->
    <ItemGroup Condition="Exists('$(PackageReadmeFileHintPath)')">
      <ReadLinesFromFile File="$(PackageReadmeFileHintPath)" />
    </ItemGroup>

    <ItemGroup>
      <ReadmeFileContents Include="$(BuildMessage)" Condition="Exists('$(PackageReadmeFileHintPath)')" />
    </ItemGroup>

    <!-- Write it to the "obj/" directory -->
    <WriteLinesToFile File="$(GeneratedPackageReadmeFileHintPath)" Lines="@(ReadmeFileContents)" Overwrite="true" />
    
    <PropertyGroup>
      <PackageReadmeFilePath>$(GeneratedPackageReadmeFileHintPath)</PackageReadmeFilePath>
      <PackageReadme>$(GeneratedPackageReadmeFileHintPath)</PackageReadme>
		</PropertyGroup>

		<ItemGroup>
			<Content Include="$(PackageReadmeFilePath)" PackagePath="README.md" Condition="Exists($(PackageReadmeFilePath))" />
		</ItemGroup>

    <PropertyGroup>
      <PackageReadmeFile Condition="Exists($(PackageReadmeFilePath))">README.md</PackageReadmeFile>
    </PropertyGroup>
  </Target> 
</Project>
